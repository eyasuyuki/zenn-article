---
title: "MySQL (MariaDB) ã§è¡Œã¨åˆ—ã‚’å…¥ã‚Œæ›¿ãˆã‚‹"
emoji: "ğŸ“Œ"
type: "tech"
topics:
  - "mysql"
  - "sql"
  - "mariadb"
  - "groupby"
published: true
published_at: "2020-11-17 16:09"
---

## çµè«–

```CASE WHEN```ã§è¡Œã‚’åˆ—ã«å¤‰æ›ã—ã€```GROUP_CONCAT```ã§é€£çµã™ã‚‹ã€‚

## ãƒ†ãƒ¼ãƒ–ãƒ«ã¨å¾—ãŸã„çµæœã®ã‚¤ãƒ¡ãƒ¼ã‚¸

ä»¥ä¸‹ã®ãƒ†ãƒ¼ãƒ–ãƒ«ãŒã‚ã£ãŸã¨ã™ã‚‹ã€‚

```
CREATE TABLE `address_entry` (
    `id` SERIAL PRIMARY KEY
    ,`address_id` bigint unsigned NOT NULL
    ,`address_type` text NOT NULL
    ,`value` text NOT NULL
    /* ,FOREIGN KEY (`address_id`) REFERENCES `address` (`id`) */
) ENGINE=InnoDB DEFAULT CHARSET = utf8;

INSERT INTO `address_entry` (`address_id`, `address_type`, `value`) VALUES (1, 'COUNTRY', 'USA');
INSERT INTO `address_entry` (`address_id`, `address_type`, `value`) VALUES (1, 'STREET', 'One Apple Park Way');
INSERT INTO `address_entry` (`address_id`, `address_type`, `value`) VALUES (1, 'CITY', 'Cupertino');
INSERT INTO `address_entry` (`address_id`, `address_type`, `value`) VALUES (1, 'STATE', 'CA');
INSERT INTO `address_entry` (`address_id`, `address_type`, `value`) VALUES (1, 'ZIP', '95014');
INSERT INTO `address_entry` (`address_id`, `address_type`, `value`) VALUES (2, 'COUNTRY', 'æ—¥æœ¬å›½');
INSERT INTO `address_entry` (`address_id`, `address_type`, `value`) VALUES (2, 'PREFECTURE', 'æ±äº¬éƒ½');
INSERT INTO `address_entry` (`address_id`, `address_type`, `value`) VALUES (2, 'CITY', 'ä¸­å¤®åŒº');
INSERT INTO `address_entry` (`address_id`, `address_type`, `value`) VALUES (2, 'STREET', 'éŠ€åº§3-5-12');
INSERT INTO `address_entry` (`address_id`, `address_type`, `value`) VALUES (2, 'BUILDING', 'ã‚µãƒ±ã‚°ã‚µãƒ“ãƒ«æœ¬é¤¨');
INSERT INTO `address_entry` (`address_id`, `address_type`, `value`) VALUES (2, 'PHONE', '03-5159-8200');
INSERT INTO `address_entry` (`address_id`, `address_type`, `value`) VALUES (2, 'POSTAL_CODE', '104-0061');

SELECT * FROM `address_entry`;
+----+------------+--------------+--------------------------+
| id | address_id | address_type | value                    |
+----+------------+--------------+--------------------------+
|  1 |          1 | COUNTRY      | USA                      |
|  2 |          1 | STREET       | One Apple Park Way       |
|  3 |          1 | CITY         | Cupertino                |
|  4 |          1 | STATE        | CA                       |
|  5 |          1 | ZIP          | 95014                    |
|  6 |          2 | COUNTRY      | æ—¥æœ¬å›½                   |
|  7 |          2 | PREFECTURE   | æ±äº¬éƒ½                   |
|  8 |          2 | CITY         | ä¸­å¤®åŒº                   |
|  9 |          2 | STREET       | éŠ€åº§3-5-12               |
| 10 |          2 | BUILDING     | ã‚µãƒ±ã‚°ã‚µãƒ“ãƒ«æœ¬é¤¨         |
| 11 |          2 | PHONE        | 03-5159-8200             |
| 12 |          2 | POSTAL_CODE  | 104-0061                 |
+----+------------+--------------+--------------------------+
```

ã“ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å…ƒã«ã€```address_type```ã‚’åˆ—ã«å±•é–‹ã—ãŸè¡¨ãŒå¾—ãŸã„ã€‚

```
+------------+-----------+--------------------+-----------+-------+-------+------------+--------------------------+--------------+-------------+
| address_id | country   | street             | city      | state | zip   | prefecture | building                 | phone        | postal_code |
+------------+-----------+--------------------+-----------+-------+-------+------------+--------------------------+--------------+-------------+
|          1 | USA       | One Apple Park Way | Cupertino | CA    | 95014 |            |                          |              |             |
|          2 | æ—¥æœ¬å›½    | éŠ€åº§3-5-12         | ä¸­å¤®åŒº    |       |       | æ±äº¬éƒ½     | ã‚µãƒ±ã‚°ã‚µãƒ“ãƒ«æœ¬é¤¨         | 03-5159-8200 | 104-0061    |
+------------+-----------+--------------------+-----------+-------+-------+------------+--------------------------+--------------+-------------+
```

## ```CASE WHEN```ã¨```GROUP BY```ã‚’ä½¿ã£ãŸå¤±æ•—ä¾‹

```CASE WHEN```ã¨```GROUP BY```ã‚’ä½¿ãˆã°è‰¯ã„ã®ã§ã¯?

```
SELECT
    `address_entry`.`address_id`
     ,CASE WHEN `address_entry`.`address_type`='COUNTRY'     THEN `address_entry`.`value` ELSE '' END AS `country`
     ,CASE WHEN `address_entry`.`address_type`='STREET'      THEN `address_entry`.`value` ELSE '' END AS `street`
     ,CASE WHEN `address_entry`.`address_type`='CITY'        THEN `address_entry`.`value` ELSE '' END AS `city`
     ,CASE WHEN `address_entry`.`address_type`='STATE'       THEN `address_entry`.`value` ELSE '' END AS `state`
     ,CASE WHEN `address_entry`.`address_type`='ZIP'         THEN `address_entry`.`value` ELSE '' END AS `zip`
     ,CASE WHEN `address_entry`.`address_type`='PREFECTURE'  THEN `address_entry`.`value` ELSE '' END AS `prefecture`
     ,CASE WHEN `address_entry`.`address_type`='BUILDING'    THEN `address_entry`.`value` ELSE '' END AS `building`
     ,CASE WHEN `address_entry`.`address_type`='PHONE'       THEN `address_entry`.`value` ELSE '' END AS `phone`
     ,CASE WHEN `address_entry`.`address_type`='POSTAL_CODE' THEN `address_entry`.`value` ELSE '' END AS `postal_code`
FROM
    `address_entry`
GROUP BY
    `address_entry`.`address_id`
;
```

```GROUP BY```ã—ã¦ã—ã¾ã†ã¨æœ€åˆã®è¡Œã—ã‹ãƒãƒƒãƒã—ãªããªã‚‹ã€‚

```
+------------+-----------+--------+------+-------+-----+------------+----------+-------+-------------+
| address_id | country   | street | city | state | zip | prefecture | building | phone | postal_code |
+------------+-----------+--------+------+-------+-----+------------+----------+-------+-------------+
|          1 | USA       |        |      |       |     |            |          |       |             |
|          2 | æ—¥æœ¬å›½    |        |      |       |     |            |          |       |             |
+------------+-----------+--------+------+-------+-----+------------+----------+-------+-------------+
2 rows in set (0.002 sec)
```

ã§ã¯ã©ã†ã—ãŸã‚‰è‰¯ã„ã®ã ã‚ã†ã‹ã€‚

## ```GROUP BY```ã‚’ã‚„ã‚ã‚‹

```GROUP BY```ã‚’å‰Šé™¤ã—ã¦ã¿ã‚‹ã€‚

```
SELECT
    `address_entry`.`address_id`
     ,CASE WHEN `address_entry`.`address_type`='COUNTRY'     THEN `address_entry`.`value` ELSE '' END AS `country`
     ,CASE WHEN `address_entry`.`address_type`='STREET'      THEN `address_entry`.`value` ELSE '' END AS `street`
     ,CASE WHEN `address_entry`.`address_type`='CITY'        THEN `address_entry`.`value` ELSE '' END AS `city`
     ,CASE WHEN `address_entry`.`address_type`='STATE'       THEN `address_entry`.`value` ELSE '' END AS `state`
     ,CASE WHEN `address_entry`.`address_type`='ZIP'         THEN `address_entry`.`value` ELSE '' END AS `zip`
     ,CASE WHEN `address_entry`.`address_type`='PREFECTURE'  THEN `address_entry`.`value` ELSE '' END AS `prefecture`
     ,CASE WHEN `address_entry`.`address_type`='BUILDING'    THEN `address_entry`.`value` ELSE '' END AS `building`
     ,CASE WHEN `address_entry`.`address_type`='PHONE'       THEN `address_entry`.`value` ELSE '' END AS `phone`
     ,CASE WHEN `address_entry`.`address_type`='POSTAL_CODE' THEN `address_entry`.`value` ELSE '' END AS `postal_code`
FROM
    `address_entry`
;
```

ä»¥ä¸‹ã®è¡¨ãŒå¾—ã‚‰ã‚Œã‚‹ã€‚

```
`+------------+-----------+--------------------+-----------+-------+-------+------------+--------------------------+--------------+-------------+
| address_id | country   | street             | city      | state | zip   | prefecture | building                 | phone        | postal_code |
+------------+-----------+--------------------+-----------+-------+-------+------------+--------------------------+--------------+-------------+
|          1 | USA       |                    |           |       |       |            |                          |              |             |
|          1 |           | One Apple Park Way |           |       |       |            |                          |              |             |
|          1 |           |                    | Cupertino |       |       |            |                          |              |             |
|          1 |           |                    |           | CA    |       |            |                          |              |             |
|          1 |           |                    |           |       | 95014 |            |                          |              |             |
|          2 | æ—¥æœ¬å›½    |                    |           |       |       |            |                          |              |             |
|          2 |           |                    |           |       |       | æ±äº¬éƒ½     |                          |              |             |
|          2 |           |                    | ä¸­å¤®åŒº    |       |       |            |                          |              |             |
|          2 |           | éŠ€åº§3-5-12         |           |       |       |            |                          |              |             |
|          2 |           |                    |           |       |       |            | ã‚µãƒ±ã‚°ã‚µãƒ“ãƒ«æœ¬é¤¨         |              |             |
|          2 |           |                    |           |       |       |            |                          | 03-5159-8200 |             |
|          2 |           |                    |           |       |       |            |                          |              | 104-0061    |
+------------+-----------+--------------------+-----------+-------+-------+------------+--------------------------+--------------+-------------+
12 rows in set (0.001 sec)
```

ã“ã®è¡¨ã‚’```GROUP BY```ã™ã‚Œã°è‰¯ã„ã®ã§ã¯?

## ```GROUP_CONCAT```ã§é€£çµã™ã‚‹

MySQL (MariaDB) ã§ã—ã‹ä½¿ãˆãªã„é›†è¨ˆé–¢æ•°```GROUP_CONCAT```ã§ã‚°ãƒ«ãƒ¼ãƒ—å†…ã®æ–‡å­—åˆ—ã‚’é€£çµã™ã‚‹ã€‚

```
SELECT
    tmp_entry.address_id
     ,GROUP_CONCAT(`tmp_entry`.`country`     SEPARATOR '') AS `country`
     ,GROUP_CONCAT(`tmp_entry`.`street`      SEPARATOR '') AS `street`
     ,GROUP_CONCAT(`tmp_entry`.`city`        SEPARATOR '') AS `city`
     ,GROUP_CONCAT(`tmp_entry`.`state`       SEPARATOR '') AS `state`
     ,GROUP_CONCAT(`tmp_entry`.`zip`         SEPARATOR '') AS `zip`
     ,GROUP_CONCAT(`tmp_entry`.`prefecture`  SEPARATOR '') AS `prefecture`
     ,GROUP_CONCAT(`tmp_entry`.`building`    SEPARATOR '') AS `building`
     ,GROUP_CONCAT(`tmp_entry`.`phone`       SEPARATOR '') AS `phone`
     ,GROUP_CONCAT(`tmp_entry`.`postal_code` SEPARATOR '') AS `postal_code`
FROM
    (SELECT
        `address_entry`.`address_id`
         ,CASE WHEN `address_entry`.`address_type`='COUNTRY'     THEN `address_entry`.`value` ELSE '' END AS `country`
         ,CASE WHEN `address_entry`.`address_type`='STREET'      THEN `address_entry`.`value` ELSE '' END AS `street`
         ,CASE WHEN `address_entry`.`address_type`='CITY'        THEN `address_entry`.`value` ELSE '' END AS `city`
         ,CASE WHEN `address_entry`.`address_type`='STATE'       THEN `address_entry`.`value` ELSE '' END AS `state`
         ,CASE WHEN `address_entry`.`address_type`='ZIP'         THEN `address_entry`.`value` ELSE '' END AS `zip`
         ,CASE WHEN `address_entry`.`address_type`='PREFECTURE'  THEN `address_entry`.`value` ELSE '' END AS `prefecture`
         ,CASE WHEN `address_entry`.`address_type`='BUILDING'    THEN `address_entry`.`value` ELSE '' END AS `building`
         ,CASE WHEN `address_entry`.`address_type`='PHONE'       THEN `address_entry`.`value` ELSE '' END AS `phone`
         ,CASE WHEN `address_entry`.`address_type`='POSTAL_CODE' THEN `address_entry`.`value` ELSE '' END AS `postal_code`
    FROM
        `address_entry`) AS `tmp_entry`
GROUP BY
    `tmp_entry`.`address_id`
;

+------------+-----------+--------------------+-----------+-------+-------+------------+--------------------------+--------------+-------------+
| address_id | country   | street             | city      | state | zip   | prefecture | building                 | phone        | postal_code |
+------------+-----------+--------------------+-----------+-------+-------+------------+--------------------------+--------------+-------------+
|          1 | USA       | One Apple Park Way | Cupertino | CA    | 95014 |            |                          |              |             |
|          2 | æ—¥æœ¬å›½    | éŠ€åº§3-5-12         | ä¸­å¤®åŒº    |       |       | æ±äº¬éƒ½     | ã‚µãƒ±ã‚°ã‚µãƒ“ãƒ«æœ¬é¤¨         | 03-5159-8200 | 104-0061    |
+------------+-----------+--------------------+-----------+-------+-------+------------+--------------------------+--------------+-------------+
2 rows in set (0.004 sec)
```

è¦ç‚¹ã¨ã—ã¦ã¯ã€å¤±æ•—ä¾‹ã§åˆ†ã‹ã‚‹ã¨ãŠã‚Š```GROUP BY```ã™ã‚‹å ´åˆã¯ä½•ã‚‰ã‹ã®é›†è¨ˆé–¢æ•°ã‚’ä½¿ã‚ãªã„ã¨çµæœãŒå¾—ã‚‰ã‚Œã‚‰ãªã„ã€‚

æ•°å€¤é …ç›®ã®å ´åˆ```COUNT```ã‚„```MAX```ã‚’ä½¿ã£ãŸä¾‹ãŒå¤šã„ãŒã€æ–‡å­—åˆ—ã®é›†è¨ˆé–¢æ•°ã¯å°‘ãªã„ã€‚```GROUP_CONCAT```ã¯æ•°å°‘ãªã„æ–‡å­—åˆ—ã®é›†è¨ˆé–¢æ•°ã§ã‚ã‚‹ã€‚

```GROUP_CONCAT```ã®æœ¬æ¥ã®ç”¨é€”ã¯ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§åˆ—ã®å€¤ã‚’é€£çµã—ãŸæ–‡å­—åˆ—ã‚’å¾—ã‚‹ã“ã¨ã ãŒã€åŒºåˆ‡ã‚Šæ–‡å­—ãŒå¤‰æ›´å¯èƒ½ãªã®ã§ç©ºæ–‡å­—åˆ—ã‚’åŒºåˆ‡ã‚Šæ–‡å­—ã«ã—ã¦é€£çµã™ã‚Œã°ä»Šå›ã®ä¾‹ã§ä¸Šè¨˜ã®çµæœãŒå¾—ã‚‰ã‚Œã‚‹ã€‚

