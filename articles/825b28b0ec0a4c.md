---
title: "fusetterã¿ãŸã„ãªã‚‚ã®ã‚’Flutterã§ä½œã£ãŸè©±"
emoji: "ğŸ“œ"
type: "tech"
topics:
  - "riverpod"
  - "hooks"
  - "flutterweb"
  - "bluesky"
  - "fusetter"
published: true
published_at: "2024-01-21 12:02"
---

è»Šè¼ªã®å†ç™ºæ˜ã£ã¦æœ¬å½“ã«æ¥½ã—ã„ã§ã™ã­ã€‚[Bluesky](https://bsky.app)ã«ã¯ã¾ã fusetterã¿ãŸã„ãªã‚‚ã®ãŒãªã„ã®ã§ã€ç”»åƒã®ALTã«ãƒã‚¿ãƒãƒ¬ã‚’æ›¸ã‘ã‚‹fusetterã¿ãŸã„ãªã‚‚ã®ã‚’ä½œã£ã¦ã¿ã¾ã—ãŸã€‚

https://eyasuyuki.github.io/bluespoiler/

Flutterã‚’æ›¸ãã®ãŒ2å¹´ã¶ã‚Šã§ãšã„ã¶ã‚“å›ã‚Šé“ã‚‚ã—ãŸã®ã§è¨˜éŒ²ã¨ã—ã¦æ›¸ã„ã¦ãŠãã¾ã™ã€‚

å…¨ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¯GitHubã«ã‚ã‚Šã¾ã™ã€‚https://github.com/eyasuyuki/bluespoiler

# fusetterã®ä¼ã›å­—ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã‚’å‹æ‰‹ã«æ¨æ¸¬ã™ã‚‹

fusetterã¯[ã¨]ã§æ‹¬ã£ãŸéƒ¨åˆ†ãŒä¼ã›å­—ã«ãªã‚Šã¾ã™ãŒã€ã©ã†ã„ã†ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã§å‹•ã„ã¦ã„ã‚‹ã‚“ã§ã—ã‚‡ã†ã‹? fusetterã®JavaScriptã‚½ãƒ¼ã‚¹ã‚’ç›—ã¿è¦‹ã¦ãƒ‘ã‚¯ã£ã¦ã‚‚é¢ç™½ããªã„ã®ã§å‹æ‰‹ã«æ¨æ¸¬ã™ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚

ã¾ãšé–‹ãæ‹¬å¼§ã¨é–‰ã˜æ‹¬å¼§ã®å‡ºç¾ä½ç½®ã‚’ä¿å­˜ã—ã¦ãŠãã“ã¨ã«ã—ã¾ã™ã€‚

```dart
// pair of brackets
class Pair {
  // field
  int start = 0;
  int end = 0;
  // constructor
  Pair({this.start = 0, this.end=0});
}
```

é–‹ãæ‹¬å¼§ã¨é–‰ã˜æ‹¬å¼§ã®å¯¾å¿œã¯ã€é–‹ãæ‹¬å¼§ã®å‡ºç¾ä½ç½®ã ã‘ã‚’ã‚¹ã‚¿ãƒƒã‚¯ã«ç©ã‚€ã“ã¨ã§è§£æã—ã¾ã™ã€‚

```dart
void setInput(String input) {
  _input = input;
  alt = [];
  List<int> stack = []; // list of '[' positions
  List<Pair> brackets = []; // list of bracket pairs

  for (int i = 0; i < _input.length; i++) {
    if (input[i] == '[') {
      stack.add(i);
    } else if (_input[i] == ']' && stack.isNotEmpty) {
      int start = stack.last;
      if (brackets.isNotEmpty) {
        Pair prev = brackets.last;
        if (start < prev.start && i > prev.end) {
          brackets.removeLast();
        }
      }
      Pair p = Pair(start: start, end: i);
      brackets.add(p);
      stack.removeLast();
    }
  }
```

é–‰ã˜æ‹¬å¼§ãŒå‡ºç¾ã—ãŸã‚‰ã€ã‚¹ã‚¿ãƒƒã‚¯ã‹ã‚‰popã—ã¦Pairã‚’ç”Ÿæˆã—ã¦bracketsã«è¿½åŠ ã—ã¾ã™ã€‚ã“ã®éš›ã€ä¸€ã¤å‰ã®Pairã¨æ¯”è¼ƒã—ã¦å¤–å´ã®æ‹¬å¼§Pairãªã‚‰ã²ã¨ã¤å‰ã‚’å‰Šé™¤ã™ã‚‹åˆ¶å¾¡ã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚

æœ€çµ‚çš„ã«ã§ããŸPair(æ‹¬å¼§ä½ç½®)ã®é…åˆ—ã§ã‚ã‚‹bracketsã‚’ä½¿ã£ã¦å¹³æ–‡æ–‡å­—åˆ—ã¨ä¼ã›å­—æ–‡å­—åˆ—ã‚’ç”Ÿæˆã—ã¦è¡Œãã¾ã™ã€‚

# TextEditingControllerã«Riverpodã¯ä½¿ã†ãª

å½“åˆçŠ¶æ…‹ç®¡ç†ã¯Riverpodã§æ›¸ã“ã†ã¨ã—ã¦ã„ãŸã®ã§ã™ãŒã€æœ€ã‚‚è‹¦åŠ´ã—ãŸã®ãŒTextFormFieldã«å…¥åŠ›ã•ã‚ŒãŸæ–‡å­—ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§Textã«è¡¨ç¤ºã—ã¦ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã™ã‚‹éƒ¨åˆ†ã€‚StreamProviderã‚’ä½¿ã†ã¹ããªã®ã‹ã¨ã‹æ•£ã€…èª¿ã¹ãŸçµæœã€Riverpodã®ä½œè€…ã®Remiã•ã‚“ãŒTextEditingControllerã«Riverpodã¯éæ¨å¥¨ãªã®ã§StatefulWidgetã‹flutter_hooksã‚’ä½¿ãˆã¨è¨€ã£ã¦ã„ã‚‹ã®ã‚’ç™ºè¦‹ã€‚

https://github.com/rrousselGit/riverpod/discussions/2680

ã“ã‚Œã‚’ç™ºè¦‹ã—ãªã‹ã£ãŸã‚‰ä½•é€±é–“ç„¡é§„ã«ã—ãŸã‹ã¨æ€ã†ã¨ã‚¾ãƒƒã¨ã—ã¾ã™ã€‚çµå±€HookWidgetã§ã‚µã‚¯ãƒƒã¨æ›¸ã‘ã¾ã—ãŸã€‚

# flutter_loginã¯ä¾¿åˆ©ã ãŒã€ãã‚‚ãã‚‚ç”»é¢é·ç§»ã™ã‚‹å¿…è¦ã‚ã‚‹ã®?

fusetterã¯Twitter APIã§æœ€åˆã«ã‚¢ãƒ—ãƒªé€£æºã—ã¦ã‹ã‚‰è¨˜äº‹ã‚’æ›¸ãã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã‘ã©ã‚‚ã€Blueskyã«ã¯ãã†ã„ã†ã‚‚ã®ãŒãªã„ã®ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```dart
final session = await bsky.createSession(
  identifier: emailController.text,
  password: passwordController.text
);
```

ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®å…¥åŠ›ç”»é¢ãŒå¿…è¦ãªã®ã§ã€å½“åˆã¯è¨˜äº‹å…¥åŠ›ç”»é¢ã§Postãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã‚‰flutter_loginã§æ›¸ã„ãŸãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«é·ç§»ã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã—ãŸã€‚ã§ã‚‚ä¸€æ™©å¯ã¦èµ·ãã¦ã¿ã‚‹ã¨**ãã‚‚ãã‚‚ç”»é¢é·ç§»ã£ã¦å¿…è¦ãªã®?** ã¨ã„ã†ç–‘å•ãŒæµ®ã‹ã‚“ã ã®ã§ã™ã€‚

æœ€çµ‚çš„ã«ã¯åŒã˜ç”»é¢ã§ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã•ã›ã‚‹ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã—ãŸã€‚

# Blueskyã¸ã®æŠ•ç¨¿ã¯ã¨ã¦ã‚‚ç°¡å˜

Bluesky APIã‚’åˆ©ç”¨ã™ã‚‹ãŸã‚ã«```bluesky```ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

```shell
flutter pub add bluesky
```

Blueskyã¸ã®æŠ•ç¨¿ã¯ã“ã‚Œã ã‘ã€‚

```dart
final session = await bsky.createSession(
  identifier: emailController.text,
  password: passwordController.text
);
final bluesky = bsky.Bluesky.fromSession(session.data);
final uploaded = await bluesky.repo.uploadBlob(imageBytes.value!);
final post = bluesky.feed.post(
  text: body,
  embed: bsky.Embed.images(
    data: bsky.EmbedImages(
      images: [
        bsky.Image(
          alt: alt,
          image: uploaded.data.blob,
        ),
      ],
    )
  ),
);
```

# ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã¨è¡¨ç¤º

å‰é …ã§ç”»åƒã‚’ä¿æŒã—ã¦ã„ãŸ```imageBytes```ã§ã™ãŒã“ã‚Œã¯ã©ã†ã‚„ã£ã¦å®šç¾©ã—ãŸã®ã§ã—ã‚‡ã†ã‹ã€‚
```HookWidget```ã®```build```ãƒ¡ã‚½ãƒƒãƒ‰ã®æœ€åˆã§ä»¥ä¸‹ã®å®šç¾©ã‚’è¡Œãªã£ã¦ã„ã¾ã™ã€‚

```dart
final imageBytes = useState<Uint8List?>(null);
```

ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®é¸æŠã¯```image_picker_web```ã‚’ä½¿ã„ã¾ã™ã€‚

```shell
flutter pub add image_picker_web
```

ç”»é¢å´ã§ã¯```ImagePickerWeb.getImageAsByte```ã‚’å‘¼ã³å‡ºã—ã¾ã™ã€‚

```dart
Future<void> pickImage() async {
  const maxImageSize = 999997;
  try {
    Uint8List? uint8list = await ImagePickerWeb.getImageAsBytes();
    if (uint8list!.lengthInBytes > maxImageSize) { // ç”»åƒã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯
      ScaffoldMessenger.of(context).showSnackBar(  // ã‚µã‚¤ã‚ºè¶…éã¯è­¦å‘Š
        SnackBar(
          content: Text(AppLocalizations.of(context)!.image_size_text),
          backgroundColor: Colors.redAccent,
        ),
      );
    } else {
      imageBytes.value = uint8list; // é¸æŠã•ã‚ŒãŸç”»åƒã§imageBytesã®å€¤ã‚’æ›´æ–°
    }
  } catch (e) {
    print(e);
  }
}
```

```maxImageSize```ã¯Blueskyã®ç”»åƒã®æœ€å¤§ãƒã‚¤ãƒˆæ•°ã§ã™ã€‚ã“ã‚Œã‚’è¶…ãˆã‚‹ç”»åƒã¯ä½¿ç”¨ã§ãã¾ã›ã‚“ã€‚
ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚µã‚¤ã‚ºã‚’ãƒã‚§ãƒƒã‚¯ã—ã€ã“ã‚Œã‚’è¶…ãˆã‚‹å ´åˆã¯```SnackBar```ã§è­¦å‘Šã—ã¾ã™ã€‚

ç”»é¢å´ã§ã¯ãƒœã‚¿ãƒ³ã®```onPressed```ã§```pickImage```ã‚’å‘¼ã³å‡ºã™ã‚ˆã†ã«ã—ã¾ã™ã€‚

```dart
ElevatedButton(
  onPressed: () async {
    await pickImage();
  },
  child: Text(AppLocalizations.of(context)!.image_button_text)
),
```

é¸æŠã•ã‚ŒãŸç”»åƒã‚’```Image```ã«è¡¨ç¤ºã—ã¾ã™ã€‚

```dart
Row(mainAxisAlignment: MainAxisAlignment.center, children: [
  Image.memory(
    imageBytes.value!,
    width: 200,
    height: 200,
  ),
  CloseButton(onPressed: () {
      imageBytes.value = null;
  })
])
```

ç”»åƒã®æ¨ªã«```CloseButton```ã‚’è¡¨ç¤ºã—ã€æŠ¼ã•ã‚ŒãŸã‚‰```imageBytes```ã®å€¤ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

ã“ã‚Œã‚‰ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆã‚’çµ„ã¿åˆã‚ã›ã¦ã€```imageBytes```ã®å€¤ãŒ```null```ã®ã¨ãã¯ç”»åƒé¸æŠãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºã—ã€ç”»åƒãŒé¸æŠã•ã‚Œã¦ã„ãŸã‚‰ãã®ç”»åƒã‚’```Image```ã«è¡¨ç¤ºã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚

```dart
imageBytes.value != null
? Row(mainAxisAlignment: MainAxisAlignment.center, children: [
    Image.memory(
      imageBytes.value!,
      width: 200,
      height: 200,
    ),
    CloseButton(onPressed: () {
        imageBytes.value = null;
    })
])
: ElevatedButton(
  onPressed: () async {
    await pickImage();
  },
  child: Text(AppLocalizations.of(context)!.image_button_text)),
```

# Blueskyã®è¨˜äº‹ãƒšãƒ¼ã‚¸URLã‚’æ¨å®šã™ã‚‹

Blueskyeã¸ã®```post```ã®æˆ»ã‚Šå€¤ã¨ã—ã¦uriã¨cidãŒè¿”ã£ã¦ãã¾ã™ã€‚

```json
{"uri":"at://did:plc:dptps7rgxju4nrg6qskop2wz/app.bsky.feed.post/3kjmvo7ocl62e","cid":"bafyreihxcb3n6hxucw3hdeb3kylhzkoumitkx4hygoy24tyxt4hemajdde"}
```

ã“ã®uriã¯atUriã¨ã„ã†ã‚‚ã®ã§ã€ATãƒ—ãƒ­ãƒˆã‚³ãƒ«ã«ãŠã„ã¦è¨˜äº‹ã‚’ãƒ¦ãƒ‹ãƒ¼ã‚¯ã«æŒ‡ã—ç¤ºã—ã¦ã„ã¾ã™ã€‚Blueskyã®è¨˜äº‹ã®URLã¯æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

```
https://bsky.app/profile/javaopen.org/post/3kjmvo7ocl62e
```

```profile```ã®æ¬¡ã®ãƒ‘ã‚¹```javaopen.org```ã¯æŠ•ç¨¿è€…ã®ãƒãƒ³ãƒ‰ãƒ«ã€æœ€å¾Œã®```3kjmvo7ocl62e```ã¯atUriã®æœ€å¾Œã®ãƒ‘ã‚¹ã¨ä¸€è‡´ã—ã¦ã„ã¾ã™ã€‚

atUriã®æœ€å¾Œã®ãƒ‘ã‚¹ã‚’å¾—ã‚‹ãŸã‚```Uri.parse```ã§è§£æã™ã‚‹ã¨portãŒä¸æ­£ã ã¨ã„ã†ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ã€‚

```dart
final uri = Uri.parse('at://did:plc:dptps7rgxju4nrg6qskop2wz/app.bsky.feed.post/3kjmvo7ocl62e');
```

```shell
Unhandled exception:
FormatException: Invalid port (at character 10)
at://did:plc:dptps7rgxju4nrg6qskop2wz/app.bsky.feed.post/3kjmvo7ocl62e
         ^
```

ãŸã—ã‹ã«portã£ã½ã„ã‚‚ã®ãŒæ•°å­—ã˜ã‚ƒãªã„ã®ã§```Uri.parse```ã¯ä½¿ãˆã¾ã›ã‚“ã€‚

ä»–ã«ã‚‚æ–¹æ³•ã¯ã‚ã‚‹ã®ã‹ã‚‚çŸ¥ã‚Œã¾ã›ã‚“ãŒã€```String.split```ã§```'/'```ã‚’ä½¿ã£ã¦åˆ†å‰²ã™ã‚‹ã“ã¨ã«ã—ã¾ã™ã€‚

```dart
final articleId = post.data.uri.href.split('/').last;
```

æŠ•ç¨¿è€…ã®ãƒãƒ³ãƒ‰ãƒ«ã¯```session```ã‹ã‚‰å¾—ã‚‰ã‚Œã¾ã™ã€‚

å†æ²
```dart
final session = await bsky.createSession(
  identifier: emailController.text,
  password: passwordController.text
);
```

æŠ•ç¨¿è€…ã®ãƒãƒ³ãƒ‰ãƒ«ã¯```session.data.handle```ã‹ã‚‰å¾—ã‚‰ã‚Œã¾ã™ã€‚ã“ã‚Œã§è¨˜äº‹ã®URLãŒç”Ÿæˆã§ãã¾ã™ã€‚

```dart
final url = Uri(
  scheme: 'https',
  host: 'bsky.app',
  pathSegments: <String>[
    'profile',
    session.data.handle,
    'post',
    articleId,
  ],
);
```

# ãƒ†ã‚¹ãƒˆç”¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ç§˜åŒ¿ã™ã‚‹

Bluesky APIã¨ã®æ¥ç¶šéƒ¨åˆ†ã®ãƒ†ã‚¹ãƒˆãŒãªã‹ã£ãŸã®ã§æ›¸ãã¾ã™ã€‚```mockito```ã‚’ä½¿ã†æ–¹ãŒè‰¯ã„ã®ã§ã—ã‚‡ã†ãŒã€ã¨ã‚Šã‚ãˆãšæœ¬ç‰©ã®ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã™ã‚‹ãƒ†ã‚¹ãƒˆã‚’æ›¸ãã“ã¨ã«ã—ã¾ã™ã€‚

ä»Šå›ã¯æœ¬ç‰©ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ç§˜åŒ¿ã™ã‚‹ãŸã‚ã€ä»¥ä¸‹ã®æ‰‹é †ã§```flutter_dotenv```ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

1. ```.gitignore```ã«```.env```ã‚’è¿½åŠ ã™ã‚‹
2. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã«```.env```ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œã‚Šç’°å¢ƒå¤‰æ•°ã‚’è¨˜è¿°ã™ã‚‹ã€‚ä»Šå›ã¯```BLUESKY_IDENTIFIER```ã¨```BLUESKY_PASSWORD```
3. ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã§```flutter pub add flutter_dotenv```ã‚’å®Ÿè¡Œã—ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨å¯èƒ½ã«ã™ã‚‹
4. ãƒ†ã‚¹ãƒˆã®ä¸­ã§```dotenv```ã‚’ä½¿ç”¨ã—ã¦ç’°å¢ƒå¤‰æ•°ã‚’èª­ã¿è¾¼ã‚€ã€‚

.envãƒ•ã‚¡ã‚¤ãƒ«(æ¶ç©ºã®è¨­å®šå€¤ã§ã™)
```
BLUESKY_IDENTIFIER=eyasuyuki
BLUESKY_PASSWORD=EotTromABdPCWHlR
```

ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰
```dart
void main() async {
  await dotenv.load(fileName: '.env');
  final id = dotenv.get('BLUESKY_IDENTIFIER');
  final password = dotenv.get('BLUESKY_PASSWORD');
```

ç’°å¢ƒå¤‰æ•°ã®èª­ã¿è¾¼ã¿ã¯```String.fromEnvironment```ã‚„```Platform.environment```ã§ã¯ãªã```dotenv.get```ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

# Riverpodã®å˜ä½“ãƒ†ã‚¹ãƒˆã‚’æ›¸ã

Bluesky APIã¨ã‚„ã‚Šã¨ã‚Šã™ã‚‹éƒ¨åˆ†ã¯ãƒœã‚¿ãƒ³ã®```onPressed```ã«ãƒ™ã‚¿æ›¸ãã—ã¦ã„ã¾ã—ãŸã€‚ã“ã‚Œã‚’åˆ†é›¢ã—ã¦ãƒ†ã‚¹ãƒˆã‚‚æ›¸ããŸã„ã®ã§Riverpodã§æ›¸ãç›´ã™ã“ã¨ã«ã—ã¾ã—ãŸã€‚

```dart
@riverpod
Future<bool> testLogin(TestLoginRef ref, {required String email, required String password}) async {
  try {
    final session = await bsky.createSession(
        identifier: email,
        password: password
    );
    switch (session.status.code) {
      case 200:
        return true;
      case 204:
        return true;
      default:
        return false;
    }
  } catch (e) {
    return false;
  }
}
```

ãƒ†ã‚¹ãƒˆã§ã¯```ProviderContainer```ã‚’ä½¿ã£ã¦ã€è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸ```testLoginProvider```ã‚’```read```ã—ã¦ã„ã¾ã™ã€‚IDã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯å‰è¿°ã®æ–¹æ³•ã§ç§˜åŒ¿ã—ãŸæœ¬ç‰©ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ä½¿ç”¨ã—ã¦æœ¬å½“ã«Blueskyã«æ¥ç¶šã—ã¦ãƒ†ã‚¹ãƒˆã—ã¦ã„ã¾ã™ã€‚

```dart
  test('test testLogin', () async {
    final container = ProviderContainer();
    // test loading
    expect(
        container.read(testLoginProvider.call(email: id, password: password)),
        const AsyncValue<bool>.loading()
    );
    // test success
    expect(
      await container.read(testLoginProvider.call(email: id, password: password).future),
      true
    );
    // test fail
    expect(
      await container.read(testLoginProvider.call(email: 'email', password: 'password').future),
      false
    );
  });
```

ç”»é¢å´ã§ã¯```ref.read```ã§èª­ã¿è¾¼ã‚“ã ```testLoginProvider```ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚Riverpodã‚’ä½¿ã†ãŸã‚ã«ã€ç”»é¢å´ã®ç¶™æ‰¿å…ƒã‚¯ãƒ©ã‚¹ã‚’```HookWidget```ã‹ã‚‰```HookConsumerWidget```ã«å¤‰æ›´ã—ã¦ã„ã¾ã™ã€‚

```dart
TextButton(
    onPressed: () async {
      await ref.read(testLoginProvider.call(email: emailController.text, password: passwordController.text).future)
          ? ScaffoldMessenger.of(context).showSnackBar(SnackBar(content: Text(AppLocalizations.of(context)!.login_success_text)))
          : ScaffoldMessenger.of(context)
              .showSnackBar(SnackBar(backgroundColor: Colors.redAccent, content: Text(AppLocalizations.of(context)!.login_failed_text)));
    },
    child: Text(AppLocalizations.of(context)!.verify_button_text),
),
```

(ã‚‚ã†ã¡ã‚‡ã£ã¨ã‚¹ãƒãƒ¼ãƒˆã«æ›¸ã‘ãªã„ã‹ã¨ã¯æ€ã£ã¦ã„ã¾ã™)

# go_routerã§å‰ã®ç”»é¢ã«æˆ»ã£ãŸã¨ãã«å…¥åŠ›å€¤ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹

æŠ•ç¨¿ã«æˆåŠŸã—ãŸã‚‰è¨˜äº‹ã®ãƒªãƒ³ã‚¯ã‚’è¡¨ç¤ºã™ã‚‹ç”»é¢ã«é·ç§»ã—ã€[åˆ¥ã®ãƒã‚¿ãƒãƒ¬ã‚’æŠ•ç¨¿ã™ã‚‹]ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸæ™‚ã«ç·¨é›†ç”»é¢ã«æˆ»ã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚

![](https://storage.googleapis.com/zenn-user-upload/330f627c8941-20240126.png)

ã“ã®ã¨ãå˜ã«```context.pop```ã‚„```context.go```ã§ç”»é¢é·ç§»ã™ã‚‹ã¨å…¥åŠ›å€¤ãŒãã®ã¾ã¾æ®‹ã£ã¦ã—ã¾ã„ã¾ã™ã€‚

```context.push```ã‚„```context.go```ã«ã¯å¼•æ•°ã‚’æ¸¡ã›ã‚‹ã®ã§ã€å‘¼ã³å‡ºã—å´ã§ã¯å¼•æ•°ã‚’ä»˜ã‘ã¦å‘¼ã³å‡ºã™ã‚ˆã†ã«ã—ã¾ã™ã€‚

```dart
context.go('/', extra: true) // true: å…¥åŠ›å€¤ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹
```

```GoRouter```ã®å®šç¾©ã§ã¯å‘¼ã³å‡ºã—å´ã®```extra:```ã«æ¸¡ã•ã‚ŒãŸå€¤ã‚’```state.extra```ã§å–å¾—ã—ã¦ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿å¼•æ•°ã¨ã—ã¦æ¸¡ã—ã¦ã„ã¾ã™ã€‚

```dart
final _router = GoRouter(
  initialLocation: '/',
  initialExtra: false,
  routes: <RouteBase>[
    GoRoute(
      path: '/',
      builder: (BuildContext context, GoRouterState state) {
        return SpoilerEditor(title: title, clearAll: state.extra as bool);
      },
    ),
```

ç”»é¢å´ã§ã¯ãã®å¼•æ•°ã§ç”»é¢ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹ã‹ã©ã†ã‹ã‚’åˆ¤å®šã™ã‚‹ã“ã¨ã«ã—ã¾ã™ã€‚ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³å¼•æ•°ã¨ã—ã¦```clearAll```ã‚’ã¨ã‚‹ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ã€‚

```dart
const SpoilerEditor({super.key, required this.title, this.clearAll = false});
```

ç”»é¢ã®åˆæœŸåŒ–å‡¦ç†ã¯```useEffect```ã‚’ä½¿ã„ã¾ã™ã€‚

```dart
// use effect
useEffect(() {
  if (clearAll) {
    inputController.clear(); // è¨˜äº‹å…¥åŠ›ã®ã‚¯ãƒªã‚¢
    imageBytes.value = null; // ç”»åƒãƒ‡ãƒ¼ã‚¿ã®ã‚¯ãƒªã‚¢
    emailController.clear(); // Emailå…¥åŠ›ã®ã‚¯ãƒªã‚¢
    passwordController.clear(); // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›ã®ã‚¯ãƒªã‚¢
  }
  return null;
}, [clearAll]);
```

æ³¨æ„ç‚¹ã¨ã—ã¦ã¯```[clearAll]```ã§ã¯ãªã```[]```ã ã¨```clearAll```ã®å€¤ãŒå¤‰åŒ–ã—ã¦ã„ã¦ã‚‚```useEffect```ã¯å®Ÿè¡Œã•ã‚Œã¾ã›ã‚“ã€‚

Riverpodã§å…¥åŠ›å€¤ã‚’ç®¡ç†ã™ã‚‹providerã‚’æ›¸ãæ–¹æ³•ãªã©æ§˜ã€…ã‚ã‚ã†ã‹ã¨ã¯æ€ã„ã¾ã™ãŒã€ã¨ã‚Šã‚ãˆãš```flutter_hooks```ã®```useEffect```ã§å®Ÿç¾ã§ãã¾ã—ãŸã€‚

# Postã«ãƒªãƒ³ã‚¯ã‚’åŸ‹ã‚è¾¼ã‚€

URLã‚’å«ã‚€Tweetã‚’è¡Œã†ã¨Twitterã§ã¯å‹æ‰‹ã«ãƒªãƒ³ã‚¯ã—ã¦ãã‚Œã¾ã™ãŒã€Blueskyã§ã¯å˜ãªã‚‹æ–‡å­—åˆ—ã¨ã—ã¦æ‰±ã‚ã‚Œã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/3ba036da5648-20240128.png)

URLã‚’æœ¬æ–‡ä¸­ã«ãƒªãƒ³ã‚¯ã¨ã—ã¦åŸ‹ã‚è¾¼ã‚€ã«ã¯Rich Textã¨ã—ã¦Postã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

[Denoã§Blueskyã«ğ‘¹ğ’Šğ’„ğ’‰ ğ’•ğ’†ğ’™ğ’•ã‚’æŠ•ç¨¿ã™ã‚‹](https://zenn.dev/kawarimidoll/articles/42efe3f1e59c13#fnref-9f6a-1) ã¨ã„ã†è¨˜äº‹ã«æ›¸ã‹ã‚Œã¦ã„ã‚‹é€šã‚Šã€Postã®éš›ã«```facets```ã¨ã„ã†Rich Textã®æƒ…å ±ã‚’ä»˜åŠ ã™ã‚Œã°è‰¯ã•ãã†ã§ã™ã€‚

ã¾ãšæ­£è¦è¡¨ç¾ã‚’ä½¿ã£ã¦æœ¬æ–‡ä¸­ã®URLã‚’æŠ½å‡ºã™ã‚‹ã“ã¨ã«ã—ã¾ã™ã€‚

```dart
List<Pair> extractUrl(String input) {
  final _regexp = RegExp(r'https?://[^\s]*');
  final matched = _regexp.allMatches(input);
  return matched.map((e) => Pair(start: e.start, end: e.end)).toList();
}
```

æœ¬æ–‡ä¸­ã®URLã®é–‹å§‹ä½ç½®ã¨çµ‚äº†ä½ç½®ãŒå¾—ã‚‰ã‚ŒãŸã®ã§ã€ã“ã‚Œã‚’ä½¿ã£ã¦facetsã‚’ç”Ÿæˆã™ã‚‹ã“ã¨ã«ã—ã¾ã™ã€‚

```dart
List<bsky.Facet> createFacets(String input, List<Pair> urls) {
  return urls.map((e) => bsky.Facet(
    index: bsky.ByteSlice(
        byteStart: e.start,
        byteEnd: e.end,
    ),
    features: [
      bsky.FacetFeature.link(
          data: bsky.FacetLink(
              uri: input.substring(e.start, e.end),
          ),
      ),
    ],
  )).toList();
}
```

Postã—ã¦ã¿ã‚‹ã¨ãƒªãƒ³ã‚¯ã®ä½ç½®ãŒãšã‚Œã¦ã„ã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/a896d4bbfcd8-20240128.png)

ä½ç½®ãŒãšã‚ŒãŸç†ç”±ã§ã™ãŒã€æ­£è¦è¡¨ç¾ã§ãƒãƒƒãƒã—ãŸé–‹å§‹ä½ç½®ã¨çµ‚äº†ä½ç½®ã¯æ–‡å­—å˜ä½ãªã®ã«å¯¾ã—ã¦ã€```Facet```ã®```index```ã¯ãƒã‚¤ãƒˆå˜ä½ã®ä½ç½®ã ã‹ã‚‰ã§ã™ã€‚ã¨ã„ã†ã‚ã‘ã§ãƒã‚¤ãƒˆå˜ä½ã®ä½ç½®ã‚’æ±‚ã‚ã‚‹ãŸã‚ã«```Pair```ã«ãƒ¡ãƒ³ãƒãƒ¼ã‚’è¿½åŠ ã—ã¦ã€ã‚‚ã†Pairã§ã¯ãªããªã£ãŸã®ã§```Region```ã«åå‰ã‚’å¤‰ãˆã‚‹ã“ã¨ã«ã—ã¾ã™ã€‚

```dart
class Region {
  // field
  int start = 0;
  int end = 0;
  int byteStart = 0;
  int byteEnd = 0;
  // constructor
  Region({this.start = 0, this.end = 0, this.byteStart = 0, this.byteEnd = 0});
}
```

Dartã®ãƒãƒ«ãƒãƒã‚¤ãƒˆæ–‡å­—åˆ—ã¯UTF-16ãªã®ã§ã€ãƒã‚¤ãƒˆå˜ä½ã®é–‹å§‹ä½ç½®ã€çµ‚äº†ä½ç½®ã‚’æ±‚ã‚ã‚‹ã«ã¯```utf8.encode(æ–‡å­—).length```ã‚’ä½¿ã„ã¾ã™ã€‚

```dart
List<Region> toByteIndices(String input, List<Region> pairs) {
  int byteIndex = 0;
  int prevBytes = 0;
  for (int i = 0; i < input.length; i++) {
    byteIndex += prevBytes;
    for (var p in pairs) {
      if (i == p.start) {
        p.byteStart = byteIndex;
      } else if (i == p.end) {
        p.byteEnd = byteIndex;
      }
    }
    prevBytes = utf8.encode(input[i]).length;
  }
  return pairs;
}
```

ã‚ã¨ã¯```facets```ã®ç”Ÿæˆã§ãƒã‚¤ãƒˆä½ç½®ã‚’ä½¿ã†ã‚ˆã†ã«å¤‰æ›´ã—ã¾ã™ã€‚

```dart
List<bsky.Facet> createFacets(String input, List<Region> urls) {
  urls = toByteIndices(input, urls); // ãƒã‚¤ãƒˆä½ç½®ã‚’æ±‚ã‚ã‚‹
  return urls.map((e) => bsky.Facet(
    index: bsky.ByteSlice(
        byteStart: e.byteStart, // ãƒã‚¤ãƒˆå˜ä½ã®é–‹å§‹ä½ç½®
        byteEnd: e.byteEnd,     // ãƒã‚¤ãƒˆå˜ä½ã®çµ‚äº†ä½ç½®
    ),
    features: [
      bsky.FacetFeature.link(
          data: bsky.FacetLink(
              uri: input.substring(e.start, e.end), // ã“ã“ã¯å¤‰æ›´ãªã—
          ),
      ),
    ],
  )).toList();
}
```

![](https://storage.googleapis.com/zenn-user-upload/bd2fef87cd71-20240128.png)

ä½ç½®ãŒãšã‚Œãšã«Postã§ãã¾ã—ãŸã€‚

# flutter-webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã—ã¦ãƒªãƒªãƒ¼ã‚¹ã—ãŸç†ç”±

ç†ç”±ã¨ã—ã¦ã¯ä»¥ä¸‹ãŒæŒ™ã’ã‚‰ã‚Œã¾ã™ã€‚

1. å®Ÿè¡Œã€ãƒ‡ãƒãƒƒã‚°ã‚’Chromeã§è¡Œã£ã¦ã„ãŸã‹ã‚‰
2. ```image_picker_web```ã‚’ä½¿ã£ã¦ã„ã‚‹ã‹ã‚‰
3. GitHubã®å…¬é–‹ãƒªãƒã‚¸ãƒˆãƒªãªã®ã§GitHub Pagesã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã®ãŒæœ€ã‚‚ç°¡å˜

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚½ãƒ¼ã‚¹ã«ã¯iosã€androidã€webã€macosã€windowsã€linuxãã‚Œãã‚Œã«å¯¾å¿œã—ãŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—å„ç’°å¢ƒå‘ã‘ã«ãƒ“ãƒ«ãƒ‰ã§ãã‚‹ã‚ˆã†ã«ã¯ãªã£ã¦ã„ã¾ã™ãŒã€é–‹ç™ºä¸­ã¯ã‚‚ã£ã±ã‚‰Chromeã§å®Ÿè¡Œã‚„ãƒ‡ãƒãƒƒã‚°ã‚’è¡Œã£ã¦ã„ã¾ã—ãŸã€‚iosã‚„androidã¯ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿/ã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ã®è¨­å®šãŒå¿…è¦ã§ã€ä½•ã®è¨­å®šã‚‚ãªã—ã«èµ·å‹•ã§ãã‚‹ã®ã¯Chromeã¨ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã ã‘ã ã‹ã‚‰ã§ã™ã€‚ãƒ¢ãƒã‚¤ãƒ«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¸ã®å¯¾å¿œã¯å¾Œã‹ã‚‰ã§ã‚‚ã§ãã‚‹ã¨æ€ã£ã¦ã„ã¾ã—ãŸã€‚

BlueSpoilerã§ã¯ç”»åƒã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™ãŒã€flutter-webã§ã¯ç”»åƒã®èª­ã¿è¾¼ã¿ã«```image_picker```ã§ã¯ãªã```image_picker_web```ã‚’ä½¿ã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚flutter-webã§ã¯```dart:io```ãŒimportã§ããªã„ãŸã‚ã§ã™ã€‚ã“ã®ãŸã‚ã€ãƒ¢ãƒã‚¤ãƒ«å‘ã‘ãƒ“ãƒ«ãƒ‰ã§ã¯```image_picker```ã‚’ä½¿ã„ã€webå‘ã‘ãƒ“ãƒ«ãƒ‰ã§ã¯```image_picker_web```ã‚’ä½¿ã†ã¨ã„ã£ãŸè¨­å®šãŒæœ¬æ¥ã¯å¿…è¦ã«ãªã‚Šã¾ã™ã€‚ä»Šå›ã¯å‹•ãã‚‚ã®ã‚’å…ˆã«ä½œã‚ŠãŸã‹ã£ãŸãŸã‚```image_picker_web```ã‚’ä½¿ã£ã¦é–‹ç™ºã—ã€ãƒ¢ãƒã‚¤ãƒ«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¸ã®å¯¾å¿œã¯å¾Œå›ã—ã«ã—ã¾ã—ãŸã€‚

BlueSpoilerã§ã¯å…¨ã¦ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’GitHubã®publicãƒªãƒã‚¸ãƒˆãƒªã§å…¬é–‹ã—ã¦ã„ã¾ã™ã€‚[Flutter Webã‚’GitHub Pagesã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹æ–¹æ³•](https://zenn.dev/r0227n/articles/flutter_web_deploy_github_pages) ã¨ã„ã†è¨˜äº‹ã‚’å‚è€ƒã«ã€å®Œæˆã—ãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’GitHub Pagesã«å…¬é–‹ã—ã¾ã—ãŸã€‚

ã„ã–å…¬é–‹ã—ã¦ã¿ã‚‹ã¨GitHub Pagesã§flutter-webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å…¬é–‹ã™ã‚‹ã®ã¯æ§˜ã€…ãªãƒ¡ãƒªãƒƒãƒˆãŒã‚ã£ãŸã®ã§ã™ã€‚

1. ãƒ‡ãƒ™ãƒ­ãƒƒãƒ‘ãƒ¼ç™»éŒ²ã‚‚ã‚¢ãƒ—ãƒªå¯©æŸ»ã‚‚å¿…è¦ãªã„
2. ãƒ›ãƒ¼ãƒ ç”»é¢ã«ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ã‚’è¿½åŠ ã™ã‚Œã°ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¨åŒæ§˜ã«æ°—è»½ã«èµ·å‹•ã§ãã‚‹
3. GitHubã«pushã™ã‚‹ã ã‘ã§ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†
4. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¯Bluesky APIã ã‘ãªã®ã§ã€ç‹¬è‡ªã®ã‚µã‚¤ãƒˆã‚’ç¨¼åƒã•ã›ã‚‹å¿…è¦ãŒãªã„

Native Apps Are Deadãªã‚“ã¦ã„ã†è¨˜äº‹ã‚‚ã‚ã‚‹ã‚ˆã†ã§ã™ãŒã€GitHubã®å…¬é–‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãªã‚‰GitHub Pagesã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã®ã¯å¤§ã„ã«ã‚¢ãƒªãªã‚“ã˜ã‚ƒãªã„ã§ã—ã‚‡ã†ã‹ã€‚

# ãƒã‚°ãƒ¬ãƒãƒ¼ãƒˆã¨è¦æœ›ã¯GitHubã¾ã§

ãƒã‚°ãƒ¬ãƒãƒ¼ãƒˆã¨è¦æœ›ã¯ä¸‹è¨˜ã«ãŠé¡˜ã„ã—ã¾ã™ã€‚

https://github.com/eyasuyuki/bluespoiler/issues

